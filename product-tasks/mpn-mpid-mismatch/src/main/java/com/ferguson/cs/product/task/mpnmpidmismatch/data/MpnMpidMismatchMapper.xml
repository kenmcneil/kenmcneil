<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ferguson.cs.product.task.mpnmpidmismatch.data.MpnMpidMismatchMapper">

	<resultMap id="MpnMpidProductMap" type="MpnMpidProductItem">
		<result column="uniqueId" property="uniqueId"/>
		<result column="productId" property="productId"/>
		<result column="manufacturer" property="manufacturer"/>
		<result column="finish" property="finish"/>
		<result column="sku" property="sku"/>
		<result column="upc" property="upc"/>
		<result column="mpn" property="mpn"/>
		<result column="mpid" property="mpid"/>
	</resultMap>
	
	<select id="getMpnMpidMissingItems" resultMap="MpnMpidProductMap">
		SELECT 
			p.uniqueId as uniqueId, 
			p.productId as productId,
			p.manufacturer as manufacturer,
			p.finish as finish,
			p.UPC as upc,
			p.sku as sku,
			vm.mpn as mpn
		FROM 
			omc.dbo.vendor_mapping vm with (nolock)
		INNER JOIN mmc.dbo.product p with (nolock)
			ON vm.manufacturer = p.manufacturer and vm.productid = p.productid and vm.finish=p.finish
		LEFT OUTER JOIN mmc.product.feiMPID fm with (nolock)
			ON fm.uniqueid = p.uniqueid
		WHERE 
			vm.vendor = 'ferguson'
		AND 
			isnumeric(vm.mpn) = 1 and fm.uniqueid is null
	</select>
	
	<select id="getMpnMpidMismatchItems" resultMap="MpnMpidProductMap">	
		SELECT 
			p.uniqueId as uniqueId, 
			p.productId as productId,
			p.manufacturer as manufacturer,
			p.finish as finish,
			p.UPC as upc,
			p.sku as sku,
			vm.mpn as mpn
			fm.mpid as mpid
		FROM 
			omc.dbo.vendor_mapping vm with (nolock)
		INNER JOIN mmc.dbo.product p with (nolock)
			ON vm.manufacturer = p.manufacturer and vm.productid = p.productid and vm.finish=p.finish
		INNER JOIN mmc.product.feiMPID fm with (nolock)
			ON fm.uniqueid = p.uniqueid
		WHERE vm.vendor = 'ferguson'
		AND isnumeric(vm.mpn) = 1
		AND CAST(fm.mpid AS BIGINT) != CAST(vm.mpn AS BIGINT)
	</select>
	
	<insert id="insertMissingFeiMpidRecords">
		INSERT INTO mmc.product.feiMPID (
			uniqueId,
			mpid
			)
		SELECT 
			p.uniqueId,
			CAST(vm.mpn as INT)
		FROM omc.dbo.vendor_mapping vm with (nolock)
		INNER JOIN mmc.dbo.product p with (nolock)
			ON vm.manufacturer = p.manufacturer and vm.productid = p.productid and vm.finish=p.finish
		LEFT OUTER JOIN mmc.product.feiMPID fm with (nolock)
			ON fm.uniqueid = p.uniqueid
		WHERE vm.vendor = 'ferguson'
		AND isnumeric(vm.mpn) = 1 and fm.uniqueid is null and TRY_CAST(vm.mpn as INT) is not  NULL
	</insert>
	
</mapper>