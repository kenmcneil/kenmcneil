<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ferguson.cs.product.task.feipricefeed.data.FeiPriceMapper">
	<resultMap id="feiPriceDataMap" type="FeiPriceData">
		<result column="uniqueId" property="uniqueId"/>
		<result column="mpid" property="mpid"/>
		<result column="price" property="price"/>
		<result column="brand" property="brand" />
		<result column="status" property="status" />
	</resultMap>

	<select id="getFullFeiPriceData" resultMap="feiPriceDataMap">
		SELECT product.uniqueId, pricebook.cost price, MPID.mpid mpid, manufacturer.name brand, status.status
        FROM mmc.product.product product
        INNER JOIN mmc.product.status status
        ON product.statusId = status.id
        INNER JOIN mmc.product.family family
        ON product.familyId = family.id
        INNER JOIN mmc.product.containerType containerType
        ON family.containerTypeId = containerType.id
        INNER JOIN mmc.product.finish finish
        ON product.finishId = finish.id
        INNER JOIN mmc.dbo.Manufacturer manufacturer
        ON family.manufacturerId = manufacturer.ID
        INNER JOIN mmc.product.feiMPID as MPID
        ON product.uniqueid = MPID.uniqueid
        INNER JOIN mmc.dbo.PriceBook_Cost pricebook
        ON product.uniqueId = pricebook.UniqueId
        INNER JOIN mmc.product.pricingFeiWhitelist pricingFeiWhitelist
        ON product.uniqueId = pricingFeiWhitelist.productUniqueId
        WHERE pricebook.PriceBookId = 1
        AND status.status IN ('stock','nonstock')
	</select>

	<select id="getFeiPriceChangesSinceLastRun" resultMap="feiPriceDataMap">
		SELECT DISTINCT pricebook.Cost price, MPID.mpid mpid, manufacturer.name brand, status.status
		FROM mmc.product.product product
		INNER JOIN mmc.product.status status
		ON product.statusId = status.id
		INNER JOIN mmc.product.family family
		ON product.familyId = family.id
		INNER JOIN mmc.product.containerType containerType
		ON family.containerTypeId = containerType.id
		INNER JOIN mmc.product.finish finish
		ON product.finishId = finish.id
		INNER JOIN mmc.dbo.Manufacturer manufacturer
		ON family.manufacturerId = manufacturer.ID
		INNER JOIN mmc.product.feiMPID as MPID
		ON product.uniqueid = MPID.uniqueid
		INNER JOIN mmc.dbo.PriceBook_Cost_Log pricebookCostLog
		ON product.uniqueId = pricebookCostLog.UniqueId
		INNER JOIN mmc.dbo.PriceBook_Cost pricebook
		ON product.uniqueId = pricebook.UniqueId
		AND pricebookCostLog.PriceBookId = pricebook.PriceBookId
		INNER JOIN mmc.product.pricingFeiWhitelist pricingFeiWhitelist
		ON product.uniqueId = pricingFeiWhitelist.productUniqueId
		WHERE pricebook.PriceBookId = 1
		AND status.status IN ('stock','nonstock')
		AND pricebookCostLog.Cost_Old != pricebookCostLog.Cost_New
		AND pricebook.Cost != pricebookCostLog.Cost_Old
		<if test="lastRanDate != null">
		AND pricebookCostLog.Update_DateTime &gt; #{lastRanDate}
		</if>
		ORDER BY mpid
	</select>

	<select id="getFeiImapPriceData" resultMap="feiPriceDataMap">
		SELECT product.uniqueId, pricebook.cost price, MPID.mpid mpid, manufacturer.name brand, status.status
		FROM mmc.product.product product
		INNER JOIN mmc.product.status status
		ON product.statusId = status.id
		INNER JOIN mmc.product.family family
		ON product.familyId = family.id
		INNER JOIN mmc.product.containerType containerType
		ON family.containerTypeId = containerType.id
		INNER JOIN mmc.product.finish finish
		ON product.finishId = finish.id
		INNER JOIN mmc.dbo.Manufacturer manufacturer
		ON family.manufacturerId = manufacturer.ID
		INNER JOIN mmc.product.feiMPID as MPID
		ON product.uniqueid = MPID.uniqueid
		INNER JOIN mmc.dbo.PriceBook_Cost pricebook
		ON product.uniqueId = pricebook.UniqueId
		INNER JOIN mmc.dbo.product_imap_flag productMap
		ON product.uniqueId = productMap.uniqueId
		WHERE pricebook.PriceBookId = 1
		AND status.status IN ('stock','nonstock')
	</select>

	<resultMap id="deprioritizedBrandViewMap" type="DeprioritizedBrandView">
		<result property="manufacturerId" column="manufacturerId" />
		<result property="manufacturerName" column="manufacturerName" />
	</resultMap>

	<select id="getDeprioritizedBrands" resultMap="deprioritizedBrandViewMap">
		SELECT deprioritizedBrand.manufacturerId manufacturerId,manufacturer.name manufacturerName FROM mmc.dbo.feiPriceFeedDeprioritizedBrand deprioritizedBrand
		INNER JOIN mmc.dbo.manufacturer manufacturer
		ON deprioritizedBrand.manufacturerId = manufacturer.id
	</select>
</mapper>
