<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ferguson.cs.product.task.feipricefeed.data.FeiPriceMapper">
	<resultMap id="feiPriceDataMap" type="FeiPriceData">
		<result column="mpid" property="mpid"/>
		<result column="price" property="price"/>
		<result column="brand" property="brand" />
		<result column="status" property="status" />
	</resultMap>

	<select id="getFullFeiPriceData" resultMap="feiPriceDataMap">
		SELECT pricebook.cost price, vendorMap.MPN mpn, manufacturer.name brand, status.status
		FROM mmc.product.product product
		INNER JOIN mmc.product.status status
		ON product.statusId = status.id
		INNER JOIN mmc.product.family family
		ON product.familyId = family.id
		INNER JOIN mmc.product.containerType containerType
		ON family.containerTypeId = containerType.id
		INNER JOIN mmc.product.finish finish
		ON product.finishId = finish.id
		INNER JOIN mmc.dbo.Manufacturer manufacturer
		ON family.manufacturerId = manufacturer.ID
		INNER JOIN omc.dbo.Vendor_Mapping vendorMap
		ON 'Ferguson' = vendorMap.Vendor
		AND vendorMap.MPN IS NOT NULL
		AND family.productId = vendorMap.ProductID
		AND finish.finish = vendorMap.Finish
		AND manufacturer.Name = vendorMap.Manufacturer
		INNER JOIN mmc.dbo.PriceBook_Cost pricebook
		ON product.uniqueId = pricebook.UniqueId
		WHERE pricebook.PriceBookId = 1
		AND status.status IN ('stock','nonstock')
		AND containerType.type = 'Product'
	</select>

	<select id="getFeiPriceChangesSinceLastRun" resultMap="feiPriceDataMap">
		SELECT DISTINCT pricebook.Cost price, vendorMap.MPN mpn, manufacturer.name brand, status.status
		FROM mmc.product.product product
		INNER JOIN mmc.product.status status
		ON product.statusId = status.id
		INNER JOIN mmc.product.family family
		ON product.familyId = family.id
		INNER JOIN mmc.product.containerType containerType
		ON family.containerTypeId = containerType.id
		INNER JOIN mmc.product.finish finish
		ON product.finishId = finish.id
		INNER JOIN mmc.dbo.Manufacturer manufacturer
		ON family.manufacturerId = manufacturer.ID
		INNER JOIN omc.dbo.Vendor_Mapping vendorMap
		ON 'Ferguson' = vendorMap.Vendor
		AND vendorMap.MPN IS NOT NULL
		AND vendorMap.MPN != ''
		AND family.productId = vendorMap.ProductID
		AND finish.finish = vendorMap.Finish
		AND manufacturer.Name = vendorMap.Manufacturer
		INNER JOIN mmc.dbo.PriceBook_Cost_Log pricebookCostLog
		ON product.uniqueId = pricebookCostLog.UniqueId
		INNER JOIN mmc.dbo.PriceBook_Cost pricebook
		ON product.uniqueId = pricebook.UniqueId
		AND pricebookCostLog.PriceBookId = pricebook.PriceBookId
		WHERE pricebook.PriceBookId = 1
		AND status.status IN ('stock','nonstock')
		AND containerType.type = 'Product'
		<if test="lastRanDate != null">
		AND pricebookCostLog.Update_DateTime &gt; #{lastRanDate}
		</if>
		ORDER BY mpn
	</select>


</mapper>