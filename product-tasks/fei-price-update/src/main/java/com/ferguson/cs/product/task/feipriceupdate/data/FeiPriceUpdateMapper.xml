<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ferguson.cs.product.task.feipriceupdate.data.FeiPriceUpdateMapper">

	<resultMap id="feiPriceUpdateDataMap" type="FeiPriceUpdateItem">
		<result column="uniqueId" property="uniqueId"/>
		<result column="mpid" property="mpid"/>
		<result column="price" property="price"/>
		<result column="baseCategoryId" property="baseCategoryId"/>
		<result column="manufacturerId" property="manufacturerId"/>
		<result column="umrpId" property="umrpId"/>
		<result column="feiOwnedProductId" property="feiOwnedProductId"/>
		<result column="feiOwnedActive" property="feiOwnedActive"/>
		<result column="pricebookId" property="pricebookId"/>	
		<result column="statusId" property="status"
				javaType="PriceUpdateStatus"
				typeHandler="com.ferguson.cs.product.task.feipriceupdate.data.IntMappedEnumTypeHandler"/>	
	</resultMap>
	
	<select id="getFeiPriceUpdateErrors" resultMap="feiPriceUpdateDataMap">
		SELECT
			uniqueId,
			mpid,
			price,
			pricebookId,
			statusId
		FROM tempData.dbo.${tempTableName}
		WHERE statusId != 0	
	</select>
	
	<select id="getPriceUpdateProductDetails"  parameterType="FeiPriceUpdateItem" resultMap="feiPriceUpdateDataMap">
		select 
			p.uniqueId as uniqueId,
			bc.base_category_id as baseCategoryId,
			m.id as manufacturerId,
			umrp.id as umrpId,
			fei.productUniqueId as feiOwnedProductId,
			fei.active as feiOwnedActive
		from
			mmc.product.product p with(NOLOCK)
			INNER JOIN mmc.dbo.product_base_category bc WITH(NOLOCK) on p.uniqueId = bc.uniqueid
			INNER JOIN mmc.product.family pf WITH(NOLOCK) ON p.familyId = pf.id
			INNER JOIN mmc.dbo.manufacturer m WITH(NOLOCK) ON pf.manufacturerId = m.id
			LEFT OUTER JOIN mmc.dbo.manufacturerIsUMRP umrp WITH(NOLOCK) ON m.id = umrp.id
			LEFT OUTER JOIN mmc.product.pricingFeiOwned fei WITH(NOLOCK) ON p.uniqueId = fei.productUniqueId		
		WHERE p.uniqueId =#{uniqueId}
	</select>
	
	<insert id="createTempTable" parameterType="java.lang.String">
	  CREATE TABLE [tempData].[dbo].[${_parameter}]
	  ( 
	        [uniqueId] [int],
	       	[mpid] [int],
	        [price] [decimal](18,2),
	        [pricebookId] [int],
	        [statusId] [int]
	  )
	</insert>
	
	<insert id="insertTempPriceUpdateRecord" parameterType="FeiPriceUpdateItem">
		INSERT INTO tempData.dbo.${tempTableName}
		(
			uniqueId,
			mpid,
			price,
			pricebookId,
			statusId
		) VALUES (
			#{uniqueId},
			#{mpid},
			#{price},
			#{pricebookId},
			#{status.intValue}
		)
	</insert>
	
	<update id="dropTempTable" parameterType="java.lang.String">
		DROP TABLE IF EXISTS tempData.dbo.${_parameter}
	</update>
	
	<!-- PDM Cost upload Job -->
	<insert id="insertCostUpdateJob" parameterType="CostUpdateJob" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO tempData.dbo.costUpdateJob(
			processType,
			jobName,
			userId,
			createdOn,
			processOn,
			status
		) VALUES (
			#{processType},
			#{jobName},
			#{userId},
			getDate(),
			#{processOn},
			#{status}
		)
	</insert>
	
	<!-- Insert temp table price update records into pricebookCostUpdates table in preparation for job execution -->
	<insert id="loadPriceBookCostUpdatesFromTempTable" parameterType="PricebookLoadCriteria" useGeneratedKeys="true" keyProperty="id">
		insert into tempData.dbo.pricebookCostUpdates (
			costUpdateJobId,
			uniqueId,
			pricebookId,
			cost,
			deletePricebookCost
			)
		select 
			#{jobId},
			uniqueId,
			pricebookId,
			price,
			#{deleteCost} 
		FROM tempData.dbo.${tempTableName}
		WHERE statusId = 0
	</insert>
	
	<select id="executePricebookUpdater" parameterType="int">
		exec mmc.dbo.dsp_pricebookCostUpdater @job = #{costUpdateJobId}
	</select>
	
	<update id="updateCostUpdateJob" parameterType="CostUpdateJob">
		UPDATE tempData.dbo.costUpdateJob
		<set>
			status = #{status},
			processOn = #{processOn}
		</set>
		<where>
			id = #{id}
		</where>
	</update>
	
	<resultMap id="CostUpdateJobMap" type="CostUpdateJob">
		<id column="id"  property="id" />
		<result column="processType" property="processType" />
		<result column="jobName" property="jobName" />
		<result column="userId" property="userId" /> 
		<result column="createdOn" property="createdOn" />
		<result column="processOn" property="processOn" />
		<result column="status" property="status" />
	</resultMap>
	
	<select id="getCostUpdateJob" parameterType="int" resultMap="CostUpdateJobMap">
		SELECT
			cuj.id,
			cuj.processType,
			cuj.jobName,
			cuj.userId,
			cuj.createdOn,
			cuj.processOn,
			cuj.status
		FROM 
			tempData.dbo.costUpdateJob cuj WITH (nolock)
		WHERE 
			cuj.id = #{costUpdateJobId}
	</select>
	
	<!-- mpid / uniqueId validation -->
	<select id="isValidMpidUniqueId" resultType="Boolean">
		SELECT CASE WHEN COUNT(uniqueId) > 0 then 1 else 0 end result 
		FROM
			product.feiMPID 
		WHERE 
			mpid = #{mpid} AND 
			uniqueId = #{uniqueId};
	</select>
	
	<select id="getPreferredVendorCost" resultType="Double">
		SELECT 
			vc.cost 		
		FROM 
			omc.dbo.vendor_cost vc WITH (NOLOCK)
		INNER JOIN 
			mmc.dbo.productPreferredVendor ppv WITH (NOLOCK) on vc.uniqueId = ppv.productUniqueid 
			AND  ppv.vendorUID = vc.vendorUID
		WHERE
			ppv.productUniqueId = #{uniqueId};
	</select>
	
	<select id="getFeiPromoProductUniqueIds" resultType="Integer">
	SELECT 
		distinct fei.productUniqueId
	FROM 
		mmc.product.pricingfeiowned fei (nolock)
	INNER JOIN mmc.dbo.product p (nolock) on fei.productuniqueid = p.uniqueid
	INNER JOIN mmc.product.feimpid mpid (nolock) on fei.productuniqueid = mpid.uniqueid
	INNER JOIN mmc.dbo.productpreferredvendor as ppv (nolock) on p.uniqueid = ppv.productuniqueid
	INNER JOIN omc.dbo.vendor_cost vc (nolock) on ppv.productuniqueid = vc.uniqueid and ppv.vendoruid = vc.vendoruid
	INNER JOIN mmc.dbo.pricebook_cost pb (nolock) on p.uniqueid = pb.uniqueid
	--to get "isActive"
	LEFT JOIN mmc.product.participationItemPartial as partcp (nolock) on pb.participationId = partcp.participationId
	--to be sure participation owns this prod
	LEFT JOIN mmc.product.participationProduct as partProd (nolock) on pb.participationId = partProd.participationId AND p.uniqueId = partProd.uniqueId
	--to find out if it's discounted
	LEFT JOIN mmc.product.participationCalculatedDiscount as discount (nolock) on pb.participationId = discount.participationId
	WHERE vc.pricedoptionid is null 
		AND pb.PriceBookId = '1' 
		AND p.status in ('stock','nonstock') 
		AND IIF(partcp.isActive = 1 AND partProd.isOwner = 1 AND discount.changeValue IS NOT NULL, 'discounted', null) = 'discounted';
	</select>
</mapper>