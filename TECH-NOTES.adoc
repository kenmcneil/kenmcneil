= Techincal Decision Notes
Tyler Van Gorder <tyler.vangorder@build.com>
:sectlinks:
:sectanchors:
:stylesheet: asciidoctor.css
:imagesdir: ./docs/images
// If not rendered on github, we use fonts for the captions, otherwise, we assign github emojis. DO NOT PUT A BLANK LINE BEFORE THIS, the ICONS don't render.
ifndef::env-github[]
:icons: font
endif::[]
ifdef::env-github[]
:important-caption: :exclamation:
:warning-caption: :x:
:caution-caption: :hand:
:note-caption: :bulb:
:tip-caption: :mag:
endif::[]

This file is intended to record some of the technical decisions that have been made as we implement the product-service domain. We intend for this to be a living document that others can reference as they start similar services.

WARNING: This is a work in progress and will be under constant change.

## Lombok

This project is currently using the Lombok java library to reduce the amount of boilerplate code within the domain model. This project ONLY uses lombok in the model layer and requires that a plugin is installed in your IDE of choice.

The following code snippet:

```java
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class UnitOfMeasure implements Serializable {

	private static final long serialVersionUID = 1L;

	private String id;
    private String code;
	private String name;
	private String description;
	private LocalDateTime createdTimestamp;
	private LocalDateTime lastModifiedTimestamp;
	private Integer version;
}
```

Results in a Lombok generated class with the following:

image:lombok-example.png[]

Mybatis uses the generated model objects and using value objects tend to be a pain. Therefore, we use the `@Data` and `@NoArgsConstructor` to keep Mybatis happy.

The `@Builder` annotation will generate a nested static class that can be used to create new instances of the model objects using a fluent API. There are a couple of "tricks" that make this feature more useful: 

- If you annotate your class with `@Builder` it also requires the `@AllArgsConstructor`. However, if you dont want all fields to be included in the builder you can create your own constructor and annotate that with `@Builder` instead. This will limit the fields you can configure through the builder.
- You can also statically create the builder class within your model and add your own methods to the builder. Lombok will augment/skip any builder methods that are already present.

NOTE: You can start with Lombok and if you choose to drop it from your service, you can use the "delombok" plugin to generate the lombok source code. You can simply copy those files over the lombok-annotated classes and drop the Lombok library from the dependencies.

Please see this link for more information: 

https://projectlombok.org/[Lombok Project Home Page]


## Conventional Commits

To facilitate the automation of releases notes/change logs and how we increment the semantic version of the services we have enabled a github application that enforces that the pull request description is in a specific format. The format communicates if a PR constitutes a fix, a new feature, and a breaking change.

IMPORTANT: For now we are just enforcing the format of the pull requestion descriptions with the intention of automating the semantic version and release notes later.

The format of the pull request description is of the form: `SODEV-xxxxx <type>: Short description.`
 
.Commit Types
|===
|Type |Description  
|fix |The change constitutes a bug fix and does not add new functionality.
|feature |New functionality has been added to the application.
|BREAKING CHANGE |The work constitutes a breaking change.
|doc |Documentation
|test |Changes to unit/integration tests 
|===

Please see these links for more information:

- https://www.conventionalcommits.org/en/v1.0.0-beta.2/#summary[Conventional Commits Summary]
- https://github.com/zieka/commit-cop[Commit Cop is a github plugin that enforces the description format]

## ASCII Doctor

The documentation contained within this repository is using ASCII Doctor rather than mark down formatting. ASCII Doctor provide better formatting options and is rendered natively on GitHub.

- https://asciidoctor.org/docs/asciidoc-syntax-quick-reference[Syntax Quick Reference]
- https://asciidoctor.org/docs/asciidoc-writers-guide[AsciiDoc Writer's Guide]
- https://gist.github.com/dcode/0cfbf2699a1fe9b46ff04c41721dda74[Hints for ASCII Doctor on GitHub]
- https://asciidoctor.org/docs/user-manual/#attributes[Attributes can be used as directives to turn styling features on/off]

[TIP]
====
The rendering of icons across environments can be a bit tricky, the following works well assuming that the asciidocotor.css file is in the same directory as the .adoc file.
====
[source]
====
 :sectlinks:
 :sectanchors:
 :stylesheet: asciidoctor.css
 // If not rendered on github, we use fonts for the captions, otherwise, we assign github emojis. DO NOT PUT A BLANK LINE BEFORE THIS, the ICONS don't render.
 ifndef::env-github[]
 :icons: font
 endif::[]
 ifdef::env-github[]
 :important-caption: :exclamation:
 :warning-caption: :x:
 :caution-caption: :hand:
 :note-caption: :bulb:
 :tip-caption: :mag:
 endif::[]
====

## Persistence Layer Using Mongo (Failed)

We first attempted to use Spring Data Mongo as the underlying data store for our product data. This ended up being problematic in that we did not have a good experience with ACID transactions and, while the spring data abstract is really nice, we did not feel Mongo was the correct choice. We  may revisit this decision using a different NO SQL store like CosmoDB.

There have been several base-level decisions that have been made to make it easier to leverage Spring Data MongoDB. Please see the stack overflow post that we created for details: 

https://stackoverflow.com/questions/54338496/spring-data-models-abstract-base-classes-with-lombok[Spring Data MongoDB Design Decisions]

The following are useful links to help clarify the difference between Spring Data vs something like mybatis-spring. Many of the low-level data access concerns are abstracted away by Spring Data:

- https://spring.io/projects/spring-data[Spring Data Overview]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#repositories[Core Spring Data Concepts]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#mapping-chapter[Spring Data Object Mapping]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#mongo-template.id-handling[ID Handling In Mongo]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#projections[Projections]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#auditing[Spring Data Auditing Support]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#mongo.repositories[Mongo DB Repository Details]
- https://docs.spring.io/spring-data/mongodb/docs/2.1.4.RELEASE/reference/html/#mongodb.repositories.queries.json-based[Using JSON Expressions For Repository Query Methods]

[IMPORTANT]
====
If you are not familar with Spring Data, I highly recommend that you read ALL of the links listed above.
====

== Spring Data JDBC (Promising, but still not quite there)

We attempted to switch to Spring Data JDBC, which uses the same metaphores for persistence as the Spring Data Mongo. The different being that it maps the Repository using a relational database.

[IMPORTANT]
====
This is NOT the same thing as Spring Data JPA/Hibernate. This is a much simplier approach to persistence.
====

This project is fairly new and while it is promising, it was lacking features like optimistic record locking. We actually have met with and talked to the lead of this project and it sounds like the project is resource constrained. As much as it would be a good choice, it feels like it might still be a couple years away from production use.

== Spring Data Commons + Mybatis

The project is currently using a hybrid customization to get us up and running quickly. The Spring Data Commons library is the library that is used as the base for all of the Spring Data derivitives. It provides capabilities for tracking auditing columns and reflective access to a version property.

We are still using Mybatis as the primary mechanism for writing and mapping database queries to our Java objet model.

The `DataAccessHelper` merges the annotation-driven functionality provided by spring-data-commons with Mybatis Function references that are used to do insert, update, and delete operations. This helper provides: 

* A method to intergate a Java model object to determine if it should be inserted/updated. The strategy used for this logic does NOT require any calls to the database but relies on the following:
. If the model object has a numeric property annoatated with `@Version` and that property is null, the model object is considered "new".
. If the model object has a property annotated with `@Id` and that property is null, the model object is considered "new".
. If the model object implements "Persistable", there is a method that can be implemented to customize the "isNew" logic.
* A method to save an entity object, passing the entity and two function references to an "insert" and "update" method. The methods are defined via Mybatis mappers. This method will determine if the entity is new and either call insert or update.

IMPORTANT: This method will manage the record version of an entity, if one is present on the model. It will also enforce optimistic record locking using the version property. This requires the mybatis insert/update to correctly use the version column.

* A method to delete an entity that will also enforce optimistic record locking if the entity has a version property.

== Data Model vs Domain Model

A "perfect" design would create a domain model that does not have any additional attributes used for persisting the model to the underlying data store. In practice, this results in a large amount of duplication and marshalling between the data and domain model.

This project uses a single domain/data model which means that the persistence attributes are mixed into the domain model. We felt this was a needed compromise to allow the implementation to be changed quickly. 

IMPORTANT: The model project has a dependency on the spring-data projects so that the model can be correctly annotated with persistence hints. We try to minimize the amount of spring-data infrastructure within the model.

== Events

This project will emit events as the models are manipulated through the APIs. The events will be published as to "topics" within a messaging broker and allow one or more downstream consumers to listen and consume those events. This service will act as the "source of truth" of product data to all downstream, transactional systems.

The need to emit events is also considered when building the APIs and we are making decisions to help scope the changed.

NOTE: As an example of how this might impact the implementation, consider the taxonomy hierarchy. The hierarchy consists of a category tree and to limit the scope and complexity, the categories, once placed within the hierarchy are immutable (they cannot be moved to some other place in the hierarchy)

== Domain-Driven-Design

This project is using domain driven design to help scope what entities are aggregate roots, aggregates, and references. This may, at first, appear to be  bit confusing, but using disipline when defining the model makes it clear where one entity begins and another ends.

== Functional Seperation of Concerns 

This application provides a REST API that can be consumed by multiple downstream clients. Additionally, this service also provides messaging infrastructure that allows downstream clients to subscribe to domain events emitted from this service. There is also a real need to allow this service to rapidly evolve as it is developed and more features are defined within the product domain.

NOTE: Separation of concerns (SoC) is a design principle for separating a computer program into distinct sections, such that each section addresses a separate concern.

This service has been separated into three layers (but you may want a 4th optional layer) to separate the functional concerns. The decision to use 3 or 4 layers can be made on a case-by-case basis within the same domain service. 

=== Rest Controller Layer

The controller layer handles the mapping from the transport/protocal layer (in this case REST over HTTP) into the service layer. This layer relies heavily on Spring's REST MVC framework to marshal those requests into strongly-typed domain objects that are used as input/outputs to the services. The REST framework also handles marshaling errors into a standard responses.

=== Service Layer

The service layer is where the primary domain business logic is encapsulated. Each service is defined as an interface/implementation pair where the implementation can have one or more dependencies on repository interfaces from the same business domain. Additionally the service implementation may require calls to other domains that manifest as service interface dependencies. All cross-domain aggregation will occur in the service layer by injecting other domain-level services.

It is also the service layer that should emit any business domain events.

=== Data Access Layer & Mybatis/Repositories.


IMPORTANT: If the service layer is orchestrating multiple calls to the database via repository calls and there is a need to use transaction/caching annotations, the scope of those cross-cutting concerns is at the service level. A developer must be careful when introducing transactions at the service level if that service makes external web service calls. You generally do not want to perform third-party calls in the scope of a database transaction.  

There are two ways to address the above concern: Either introduce a data access/implementation pair and use that as the aggregation point with cross-cutting concerns OR use a transaction template to insure the calls to the external service are performed outside of the transaction. 

A developer must make the correct decision for each use case and its OK to mix both approaches in a single service, just make it clear in your documentation if you have something complex.